version: "3.8"

services:
  # PostgreSQL database (can be used as Airbyte destination)
  postgres:
    image: postgres:16-alpine
    container_name: postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: mtg_analyzer
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Airbyte internal database
  airbyte-db:
    image: postgres:13-alpine
    container_name: airbyte-db
    environment:
      POSTGRES_USER: docker
      POSTGRES_PASSWORD: docker
      POSTGRES_DB: airbyte
    volumes:
      - airbyte_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U docker -d airbyte"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Airbyte Temporal service
  airbyte-temporal:
    image: airbyte/temporal:0.64.6
    container_name: airbyte-temporal
    environment:
      DB: postgresql
      DB_PORT: 5432
      POSTGRES_USER: docker
      POSTGRES_PWD: docker
      POSTGRES_SEEDS: airbyte-db
      DYNAMIC_CONFIG_FILE_PATH: config/dynamicconfig/development.yaml
    depends_on:
      airbyte-db:
        condition: service_healthy

  # Airbyte Server
  airbyte-server:
    image: airbyte/server:0.64.6
    container_name: airbyte-server
    environment:
      AIRBYTE_VERSION: 0.64.6
      DATABASE_USER: docker
      DATABASE_PASSWORD: docker
      DATABASE_URL: jdbc:postgresql://airbyte-db:5432/airbyte
      WORKSPACE_ROOT: /tmp/workspace
      CONFIG_ROOT: /data/config
      TRACKING_STRATEGY: segment
      TEMPORAL_HOST: airbyte-temporal:7233
      WEBAPP_URL: http://localhost:8000
      LOG_LEVEL: INFO
    ports:
      - "8001:8001"
    volumes:
      - airbyte_workspace:/tmp/workspace
      - airbyte_data:/data
    depends_on:
      airbyte-db:
        condition: service_healthy
      airbyte-temporal:
        condition: service_started

  # Airbyte Worker
  airbyte-worker:
    image: airbyte/worker:0.64.6
    container_name: airbyte-worker
    environment:
      AIRBYTE_VERSION: 0.64.6
      DATABASE_USER: docker
      DATABASE_PASSWORD: docker
      DATABASE_URL: jdbc:postgresql://airbyte-db:5432/airbyte
      WORKSPACE_ROOT: /tmp/workspace
      CONFIG_ROOT: /data/config
      TEMPORAL_HOST: airbyte-temporal:7233
      LOG_LEVEL: INFO
    volumes:
      - airbyte_workspace:/tmp/workspace
      - airbyte_data:/data
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      airbyte-db:
        condition: service_healthy
      airbyte-temporal:
        condition: service_started

  # Airbyte Webapp
  airbyte-webapp:
    image: airbyte/webapp:0.64.6
    container_name: airbyte-webapp
    environment:
      AIRBYTE_VERSION: 0.64.6
      API_URL: http://localhost:8001/api/v1
      INTERNAL_API_HOST: airbyte-server:8001
    ports:
      - "8000:8000"
    depends_on:
      - airbyte-server

  # Airbyte Connector Builder Server
  airbyte-connector-builder-server:
    image: airbyte/connector-builder-server:0.64.6
    container_name: airbyte-connector-builder-server
    ports:
      - "8003:8003"
    environment:
      AIRBYTE_VERSION: 0.64.6

volumes:
  postgres_data:
  airbyte_db_data:
  airbyte_workspace:
  airbyte_data:
